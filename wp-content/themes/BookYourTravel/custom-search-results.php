<?php/* Template Name: Custom Search Results *//* The template for displaying the custom search results page. * * @package WordPress * @subpackage BookYourTravel * @since Book Your Travel 1.0 */get_header(); byt_breadcrumbs();get_sidebar('under-header');global $currency_symbol;$default_results_view = (int)of_get_option('search_results_default_view', 0);$accommodation_types_args = array('taxonomy'=>'accommodation_type', 'hide_empty'=>'1');$car_types_args = array('taxonomy'=>'car_type', 'hide_empty'=>'1');$accommodation_types = get_categories($accommodation_types_args);$car_types = get_categories($car_types_args);$location_string = '';if (isset($_GET['term'])) {	$location_string = wp_kses($_GET['term'], '');	}$location_string_2 = '';if (isset($_GET['term_to'])) {	$location_string_2 = wp_kses($_GET['term_to'], '');	}$age = 0;if (isset($_GET['age'])) {	$age = intval(wp_kses($_GET['age'], '0'));}$what = '1';if (isset($_GET['what'])) {	$what = wp_kses($_GET['what'], '');	}$is_self_catered = 0;if ($what == '2')	$is_self_catered = 1;$car_types_array = array();if (isset($_GET['car_types'])) {	$query_string = explode("&",$_SERVER['QUERY_STRING']);	foreach ($query_string as $part) {		if (strpos($part,"car_types") !== false) {			$split = strpos($part,"=");			$car_type = intval(substr($part, $split + 1));			if ($car_type > 0)				$car_types_array[] = $car_type;		}	}}	$accommodation_types_array = array();if (isset($_GET['acc'])) {	$query_string = explode("&",$_SERVER['QUERY_STRING']);	foreach ($query_string as $part) {		if (strpos($part,"acc") !== false) {			$split = strpos($part,"=");			$accommodation_type = intval(substr($part, $split + 1));			if ($accommodation_type > 0)				$accommodation_types_array[] = $accommodation_type;		}	}}$sort_by = '1';if (isset($_GET['sb']))	$sort_by = wp_kses($_GET['sb'], '');$sort_order = '1';if (isset($_GET['so']))	$sort_order = wp_kses($_GET['so'], '');$custom_search_results_page_id = get_current_language_page_id(of_get_option('redirect_to_search_results', ''));$custom_search_results_page = get_permalink($custom_search_results_page_id);$now = time();$date = date('Y-m-d', $now);global $date_from, $date_to;$date_from = $date;$date_to = date('Y-m-d', strtotime("+1 day", $now));// retrieve from and to dates from querystring if providedif (isset($_GET['from']) || isset($_GET['to'])) {	parse_str(urldecode($_SERVER['QUERY_STRING']), $get_array);	if (isset($get_array['from']) && (!empty($get_array['from'])))		$date_from = date('Y-m-d', strtotime($get_array['from']));	if (isset($get_array['to']) && (!empty($get_array['to'])))		$date_to = date('Y-m-d', strtotime($get_array['to']));}$stars = 0;if (isset($_GET['stars'])) {	$stars = intval(wp_kses($_GET['stars'], ''));}$price_array = array();if (isset($_GET['price'])) {	$query_string = explode("&",$_SERVER['QUERY_STRING']);	foreach ($query_string as $part) {		if (strpos($part,"price") !== false) {			$split = strpos($part,"=");			$price_array[] = substr($part, $split + 1);		}	}}$rating = 0;if (isset($_GET['rating'])) {	$rating = wp_kses($_GET['rating'], '');	}$guests = 0;if (isset($_GET['guests'])) {	$guests = wp_kses($_GET['guests'], '');	}$rooms = 0;if (isset($_GET['rooms'])) {	$rooms = intval(wp_kses($_GET['rooms'], '0'));	}$accommodation_review_fields = list_accommodation_review_fields();$paged = (get_query_var('paged')) ? get_query_var('paged') : 1;$posts_per_page = of_get_option('accommodations_search_posts_per_page', 12);if ($what == 1 || $what == 2) {	$results = search_accommodations($location_string, $date_from, $date_to, $paged, $posts_per_page, $sort_by, $sort_order, $stars, $price_array, $rating, $accommodation_types_array, $rooms, $is_self_catered);	$current_url = $custom_search_results_page . '?from=' . urlencode($date_from) . '&to=' . urlencode($date_to) . '&term=' . $location_string . '&what=' . $what;} else if ($what == 3) {	$results = search_car_rentals($location_string, $location_string_2, $date_from, $date_to, $paged, $posts_per_page, $sort_by, $sort_order, $price_array, $car_types_array, $age);	$current_url = $custom_search_results_page . '?from=' . urlencode($date_from) . '&to=' . urlencode($date_to) . '&term=' . $location_string . '&term_to=' . $location_string_2 . '&what=' . $what;} else if ($what == 4) {	$results = search_tours($location_string, $date_from, $paged, $posts_per_page, $sort_by, $sort_order, $price_array, $guests);	$current_url = $custom_search_results_page . '?from=' . urlencode($date_from) . '&term=' . $location_string . '&what=' . $what;}?><script type="text/javascript">	jQuery.noConflict();	jQuery(document).ready(function() {		jQuery('dt').each(function() {			var tis = jQuery(this), state = false, answer = tis.next('dd').hide().css('height','auto').slideUp();			tis.click(function() {				state = !state;				answer.slideToggle(state);				tis.toggleClass('active',state);			});		});						jQuery('#star').raty({			scoreName: 'stars',			score    : <?php echo $stars; ?>		});				jQuery("#slider").on("slidechange", function(event, ui) {		   jQuery('input#rating').val(ui.value);		});	});		jQuery(window).load(function () {		var maxHeight = 0;					jQuery(".three-fourth .one-fourth .description").each(function(){		if (jQuery(this).height() > maxHeight) { maxHeight = jQuery(this).height(); }		});		jQuery(".three-fourth .one-fourth .description").height(maxHeight);		});	</script>	<!--sidebar-->	<aside class="left-sidebar">		<article class="refine-search-results">			<form id="side-search" method="get" action="<?php echo $custom_search_results_page; ?>">				<h2><?php _e('Refine search results', 'bookyourtravel'); ?></h2>				<dl>					<input name="what" id="what" value="<?php echo $what;?>" type="hidden" />					<!--Price (per night)-->					<?php 												$price_range_bottom = of_get_option('price_range_bottom', '0');						$price_range_increment = of_get_option('price_range_increment', '50');						$price_range_count = of_get_option('price_range_count', '5');						$default_currency = strtoupper(of_get_option('default_currency_select', 'USD'));													if ($price_range_count > 0) {					?>					<?php if ($what == 1 || $what == 2) { ?>					<dt><?php _e('Price (per night)', 'bookyourtravel'); ?></dt>					<?php } elseif ($what == 3) { ?>					<dt><?php _e('Price (per day)', 'bookyourtravel'); ?></dt>					<?php } elseif ($what == 4) { ?>					<dt><?php _e('Price (per person)', 'bookyourtravel'); ?></dt>					<?php } ?>					<dd>						<?php 							$bottom = 0;							$top = 0;							$out = '';							for ($i=0; $i<$price_range_count;$i++) { 						?>						<div class="checkbox">							<input type="checkbox" id="price<?php echo $i+1; ?>" name="price[]" value="<?php echo $i+1; ?>" />							<label for="price<?php echo $i+1; ?>">							<?php																$bottom = ($i * $price_range_increment) + $price_range_bottom;								$top = (($i+1) * $price_range_increment) + $price_range_bottom - 1;																$out = $bottom;								if ($i == ($price_range_count-1)) {									$out.=  ' <span class="curr">' . $currency_symbol . '</span> +';								} else {									$out.= " - " . $top . ' <span class="curr">' . $currency_symbol . '</span>';								}																echo $out;							?>							</label>						</div>						<?php } ?>					</dd>					<!--//Price (per night)-->					<?php } ?>										<?php if ($what == 1 || $what == 2) { ?>					<dt><?php _e('Accommodation type', 'bookyourtravel'); ?></dt>					<dd>					<?php for ($i = 0; $i < count($accommodation_types); $i++) { 						$accommodation_type = $accommodation_types[$i];					?>						<div class="checkbox">							<input value="<?php echo $accommodation_type->term_id; ?>" type="checkbox" id="ch<?php echo $i + 1; ?>" name="acc[]" />							<label for="ch<?php echo $i + 1; ?>"><?php echo $accommodation_type->name; ?></label>						</div>					<?php } ?>					</dd>					<!--//Accommodation type-->										<!--Star rating-->					<dt><?php _e('Star rating', 'bookyourtravel'); ?></dt>					<dd>						<span class="stars-info"><?php echo $stars; ?> or more</span>						<div id="star" data-rating="<?php echo $stars; ?>"></div>					</dd>					<!--//Star rating-->									<!--User rating-->					<dt><?php _e('User rating', 'bookyourtravel'); ?></dt>					<dd>						<div id="slider"></div>						<input type="hidden" id="rating" name="rating" value="" />						<span class="min">0</span><span class="max">10</span>					</dd>					<!--//User rating-->					<?php } elseif ($what == 3) { ?>					<dt><?php _e('Car type', 'bookyourtravel'); ?></dt>					<dd>					<?php for ($i = 0; $i < count($car_types); $i++) { 						$car_type = $car_types[$i];					?>						<div class="checkbox">							<input value="<?php echo $car_type->term_id; ?>" type="checkbox" id="cth<?php echo $i + 1; ?>" name="car_types[]" />							<label for="cth<?php echo $i + 1; ?>"><?php echo $car_type->name; ?></label>						</div>					<?php } ?>					</dd>					<!--//Accommodation type-->					<?php } ?>				</dl>								<div class="f-item datepicker">					<span><?php _e('Date from', 'bookyourtravel'); ?></span>					<div class="datepicker-wrap"><input type="text" placeholder="" id="from" name="from" /></div>				</div>				<?php if ($what == 1 || $what == 2 || $what == 3) { ?>				<div class="f-item datepicker">					<span><?php _e('Date to', 'bookyourtravel'); ?></span>					<div class="datepicker-wrap"><input type="text" placeholder="" id="to" name="to" /></div>				</div>				<?php } ?>				<?php if ($what == 1 || $what == 2) { ?>				<div id="destination" name="destination" class="f-item">					<span><?php _e('Your destination', 'bookyourtravel'); ?></span>					<input type="text" placeholder="<?php _e('City, region, district or specific accommodation', 'bookyourtravel'); ?>" id="term" name="term" />				</div>				<?php } elseif ($what == 3) { ?>				<div id="destination" name="destination" class="f-item">					<span><?php _e('Pick Up', 'bookyourtravel'); ?></span>					<input type="text" placeholder="<?php _e('I want to pick up car in', 'bookyourtravel'); ?>" id="term" name="term" />				</div>								<div id="destination2" name="destination2" class="f-item">					<span><?php _e('Drop Off', 'bookyourtravel'); ?></span>					<input type="text" placeholder="<?php _e('I want to drop off car at', 'bookyourtravel'); ?>" id="term_to" name="term_to" />				</div>								<?php } elseif ($what == 4) { ?>				<div id="destination" name="destination" class="f-item">					<span><?php _e('Tour location', 'bookyourtravel'); ?></span>					<input type="text" placeholder="<?php _e('City, region, district or specific tour', 'bookyourtravel'); ?>" id="term" name="term" />				</div>				<?php } ?>				<input type="submit" value="<?php _e('Search again', 'bookyourtravel'); ?>" class="gradient-button" id="search-submit" />			</form>		</article>	</aside>	<!--//sidebar-->	<!--three-fourth content-->	<section class="three-fourth">	<?php 	$enable_car_rentals = of_get_option('enable_car_rentals', 1); 		if ($enable_car_rentals && $what == 3) {		?>			<script>				window.formMultipleError = '<?php _e('You failed to provide {0} fields. They have been highlighted below.', 'bookyourtravel');  ?>';			</script>			<?php			get_template_part('includes/parts/car_rental', 'booking-form');			get_template_part('includes/parts/car_rental', 'confirmation-form');		}	?>		<div class="sort-by">			<h3><?php _e('Sort by', 'bookyourtravel'); ?></h3>			<ul class="sort">				<li><?php _e('Price', 'bookyourtravel'); ?> <a href="<?php echo $current_url . '&sb=1&so=1'; ?>" title="<?php _e('ascending', 'bookyourtravel'); ?>" class="ascending"><?php _e('ascending', 'bookyourtravel'); ?></a><a href="<?php echo $current_url . '&sb=1&so=2'; ?>" title="<?php _e('descending', 'bookyourtravel'); ?>" class="descending"><?php _e('descending', 'bookyourtravel'); ?></a></li>				<?php if ($what == 1 || $what == 2) { ?>				<li><?php _e('Stars', 'bookyourtravel'); ?> <a href="<?php echo $current_url . '&sb=2&so=1'; ?>" title="<?php _e('ascending', 'bookyourtravel'); ?>" class="ascending"><?php _e('ascending', 'bookyourtravel'); ?></a><a href="<?php echo $current_url . '&sb=2&so=2'; ?>" title="<?php _e('descending', 'bookyourtravel'); ?>" class="descending"><?php _e('descending', 'bookyourtravel'); ?></a></li>				<li><?php _e('Rating', 'bookyourtravel'); ?> <a href="<?php echo $current_url . '&sb=3&so=1'; ?>" title="<?php _e('ascending', 'bookyourtravel'); ?>" class="ascending"><?php _e('ascending', 'bookyourtravel'); ?></a><a href="<?php echo $current_url . '&sb=3&so=2'; ?>" title="<?php _e('descending', 'bookyourtravel'); ?>" class="descending"><?php _e('descending', 'bookyourtravel'); ?></a></li>				<?php } ?>			</ul>						<ul class="view-type">				<script>					window.defaultResultsView = <?php echo $default_results_view; ?>;				</script>				<li class="grid-view <?php echo ($default_results_view === 0) ? 'active' : ''; ?>"><a href="#" title="grid view"><?php _e('grid view', 'bookyourtravel'); ?></a></li>				<li class="list-view <?php echo ($default_results_view === 1) ? 'active' : ''; ?>"><a href="#" title="list view"><?php _e('list view', 'bookyourtravel'); ?></a></li>			</ul>		</div>			<div class="deals clearfix">			<!--deal-->			<?php                                                 			if (count($results) > 0 && $results['total'] > 0) {                            				foreach ($results['results'] as $result) { 					global $post, $tour_class, $car_rental_class, $accommodation_class;					$post = $result;					setup_postdata( $post ); 					if ($what == 1 || $what == 2) {						$accommodation_class = 'one-fourth';						get_template_part('includes/parts/accommodation', 'item');					} elseif ($what == 3) {						$car_rental_class = 'one-fourth';						get_template_part('includes/parts/car_rental', 'item');					} elseif ($what == 4) {						$tour_class = 'one-fourth';						get_template_part('includes/parts/tour', 'item');					}				} ?>				<!--//deal-->				<nav class="page-navigation bottom-nav">					<!--back up button-->					<a href="#" class="scroll-to-top" title="<?php _e('Back up', 'bookyourtravel'); ?>"><?php _e('Back up', 'bookyourtravel'); ?></a> 					<!--//back up button-->					<!--pager-->					<div class="pager">						<?php byt_display_pager($results['total']/$posts_per_page); ?>					</div>				</nav>			<?php } ?>		</div>	</section><?php 	wp_reset_postdata();	get_footer(); ?>